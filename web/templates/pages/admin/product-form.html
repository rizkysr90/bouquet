{{ define "admin-content-form" }}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">{{ if .IsEdit }}Edit Product{{ else }}Create New Product{{ end }}</h1>
        <p class="text-sm text-gray-600 mt-1">Fill in the product information below</p>
    </div>

    <form method="POST" 
          action="{{ if and .IsEdit .Product }}/admin/products/{{ .Product.ID }}{{ else }}/admin/products{{ end }}" 
          enctype="multipart/form-data"
          class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-6">
        
        <!-- CSRF Token -->
        <input type="hidden" name="_csrf" value="{{ .CSRFToken }}">

        <!-- Basic Information -->
        <div class="space-y-4">
            <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">Basic Information</h2>
            
            <!-- Code -->
            <div>
                <label for="code" class="block text-sm font-medium text-gray-700 mb-1">Product Code *</label>
                <input type="text" 
                       id="code" 
                       name="code" 
                       value="{{ if .Product }}{{ .Product.Code }}{{ end }}"
                       required
                       placeholder="Product code"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
            </div>

            <!-- Title -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Product Title *</label>
                <input type="text" 
                       id="title" 
                       name="title" 
                       value="{{ if .Product }}{{ .Product.Title }}{{ end }}"
                       required
                       minlength="5"
                       maxlength="200"
                       placeholder="Kertas Bouquet Premium Gold"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
            </div>

            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="description" 
                          name="description" 
                          rows="4"
                          placeholder="Product description..."
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">{{ if .Product }}{{ .Product.Description }}{{ end }}</textarea>
            </div>

            <!-- Category & Price Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Category -->
                <div>
                    <label for="category_id" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="category_id" 
                            name="category_id"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                        <option value="">Select Category</option>
                        {{ range .Categories }}
                        <option value="{{ .ID }}" {{ if and $.Product $.Product.CategoryID (eq (derefInt $.Product.CategoryID) .ID) }}selected{{ end }}>
                            {{ .Name }}
                        </option>
                        {{ end }}
                    </select>
                </div>

                <!-- Base Price -->
                <div>
                    <label for="base_price" class="block text-sm font-medium text-gray-700 mb-1">Base Price (Rp) *</label>
                    <input type="number" 
                           id="base_price" 
                           name="base_price" 
                           value="{{ if .Product }}{{ printf "%.0f" .Product.BasePrice }}{{ end }}"
                           required
                           min="0.01"
                           step="0.01"
                           placeholder="50000"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                </div>
            </div>

            <!-- Availability Flag -->
            <div class="flex gap-6">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" 
                           name="is_sold" 
                           value="on"
                           {{ if and .Product .Product.IsSold }}checked{{ end }}
                           class="rounded border-gray-300 text-pink-600 focus:ring-pink-500">
                    <span class="text-sm text-gray-700">Sold Out (Habis)</span>
                </label>
            </div>
        </div>

        <!-- Main Photo -->
        <div class="space-y-4">
            <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">Main Photo</h2>
            
            <div>
                <label for="main_photo" class="block text-sm font-medium text-gray-700 mb-1">Upload Photo</label>
                <input type="file" 
                       id="main_photo" 
                       name="main_photo" 
                       accept="image/jpeg,image/png,image/webp"
                       onchange="previewImage(this, 'main-photo-preview')"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                <p class="mt-1 text-xs text-gray-500">JPG, PNG, or WebP (max 5MB)</p>
            </div>

            <!-- Photo Preview -->
            <div id="main-photo-preview-container" class="{{ if .Product }}{{ if not .Product.MainPhotoURL }}hidden{{ end }}{{ else }}hidden{{ end }}">
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Photo</label>
                <div class="relative inline-block">
                    <img id="main-photo-preview" 
                         src="{{ if .Product }}{{ if .Product.MainPhotoURL }}{{ .Product.MainPhotoURL }}{{ end }}{{ end }}"
                         alt="Preview"
                         class="w-48 h-48 object-cover rounded-lg border border-gray-300">
                </div>
            </div>
        </div>

        <!-- Variants -->
        <div class="space-y-4">
            <div class="flex items-center justify-between border-b border-gray-200 pb-2">
                <h2 class="text-lg font-semibold text-gray-900">Variants</h2>
                <button type="button" 
                        onclick="addVariant()"
                        class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
                    + Add Variant
                </button>
            </div>

            <div id="variants-container" class="space-y-4">
                {{ if and .Product .Product.Variants }}
                {{ range .Product.Variants }}
                <div class="variant-item border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Color *</label>
                            <input type="text" 
                                   name="variants[][color]" 
                                   value="{{ .Color }}"
                                   required
                                   placeholder="Red"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Photo</label>
                            <input type="file" 
                                   name="variants[][photo]" 
                                   accept="image/jpeg,image/png,image/webp"
                                   onchange="previewVariantPhoto(this, 'variant-preview-{{ .Color }}')"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                            <div id="variant-preview-{{ .Color }}-container" class="mt-2 {{ if not .PhotoURL }}hidden{{ end }}">
                                <img id="variant-preview-{{ .Color }}" 
                                     src="{{ if .PhotoURL }}{{ .PhotoURL }}{{ else }}data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect fill='%23e5e7eb' width='64' height='64'/%3E%3Ctext fill='%239ca3af' font-family='sans-serif' font-size='10' dy='10.5' font-weight='bold' x='50%25' y='50%25' text-anchor='middle'%3ENo Image%3C/text%3E%3C/svg%3E{{ end }}" 
                                     alt="{{ .Color }}" 
                                     class="w-16 h-16 object-cover rounded border border-gray-300">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price Adjustment (Rp)</label>
                            <input type="number" 
                                   name="variants[][price_adjustment]" 
                                   value="{{ printf "%.0f" .PriceAdjustment }}"
                                   step="0.01"
                                   placeholder="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" 
                                       name="variants[][is_sale]" 
                                       value="on"
                                       {{ if .IsSale }}checked{{ end }}
                                       class="w-4 h-4 rounded border-gray-300 text-pink-600 focus:ring-2 focus:ring-pink-500">
                                <span class="text-sm font-medium text-gray-700">
                                    <span class="inline-block px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-semibold mr-1">SALE</span>
                                    (unchecked = SOLD)
                                </span>
                            </label>
                        </div>
                        <div class="flex items-end">
                            <button type="button" 
                                    onclick="removeVariant(this)"
                                    class="w-full bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-lg transition">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
            <a href="/admin/products" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                Cancel
            </a>
            <button type="submit" 
                    name="action" 
                    value="save"
                    class="px-6 py-2 bg-pink-600 hover:bg-pink-700 text-white font-medium rounded-lg transition">
                {{ if .IsEdit }}Update Product{{ else }}Save Product{{ end }}
            </button>
            {{ if not .IsEdit }}
            <button type="submit" 
                    name="action" 
                    value="save_and_new"
                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition">
                Save & Add New
            </button>
            {{ end }}
        </div>
    </form>
</div>

<script>
    let variantIndex = {{ if .Product }}{{ len .Product.Variants }}{{ else }}0{{ end }};

    function addVariant() {
        const container = document.getElementById('variants-container');
        const variantHtml = `
            <div class="variant-item border border-gray-200 rounded-lg p-4 bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Color *</label>
                        <input type="text" 
                               name="variants[${variantIndex}][color]" 
                               required
                               placeholder="Red"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Photo</label>
                        <input type="file" 
                               name="variants[${variantIndex}][photo]" 
                               accept="image/jpeg,image/png,image/webp"
                               onchange="previewVariantPhoto(this, 'variant-preview-new-${variantIndex}')"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                        <div id="variant-preview-new-${variantIndex}-container" class="mt-2 hidden">
                            <img id="variant-preview-new-${variantIndex}" 
                                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect fill='%23e5e7eb' width='64' height='64'/%3E%3Ctext fill='%239ca3af' font-family='sans-serif' font-size='10' dy='10.5' font-weight='bold' x='50%25' y='50%25' text-anchor='middle'%3ENo Image%3C/text%3E%3C/svg%3E" 
                                 alt="Preview" 
                                 class="w-16 h-16 object-cover rounded border border-gray-300">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price Adjustment (Rp)</label>
                        <input type="number" 
                               name="variants[${variantIndex}][price_adjustment]" 
                               step="0.01"
                               placeholder="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" 
                                   name="variants[${variantIndex}][is_sale]" 
                                   value="on"
                                   class="w-4 h-4 rounded border-gray-300 text-pink-600 focus:ring-2 focus:ring-pink-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="inline-block px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-semibold mr-1">SALE</span>
                                (unchecked = SOLD)
                            </span>
                        </label>
                    </div>
                    <div class="flex items-end">
                        <button type="button" 
                                onclick="removeVariant(this)"
                                class="w-full bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-lg transition">
                            Remove
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', variantHtml);
        variantIndex++;
    }

    function removeVariant(button) {
        button.closest('.variant-item').remove();
    }

    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const container = document.getElementById(previewId + '-container');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                container.classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function previewVariantPhoto(input, previewId) {
        const preview = document.getElementById(previewId);
        const container = document.getElementById(previewId + '-container');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                if (container) {
                    container.classList.remove('hidden');
                }
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            // If no file selected, hide preview (or show placeholder)
            if (container && !preview.src.includes('data:image')) {
                container.classList.add('hidden');
            }
        }
    }
</script>
{{ end }}

